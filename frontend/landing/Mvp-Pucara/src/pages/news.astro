---
import Layout from "../layouts/Layout.astro";
---

<Layout 
    title="Noticias - Pucar치 Gaming"
    description="Mantenete al d칤a con las 칰ltimas noticias, resultados de torneos, fichajes y novedades de Pucar치 Gaming. Todo sobre nuestros equipos de Dota 2, Street Fighter y m치s."
>
    <main class="font-ubuntu bg-primary-subtle text-light min-h-screen" role="main">
        <a href="#main-content" class="skip-link">Saltar al contenido principal</a>
        
        <div id="main-content" class="max-w-6xl mx-auto px-5 py-12">
            <!-- Header -->
            <header role="banner" class="text-center mb-12">
                <h1 class="text-4xl md:text-6xl font-bold uppercase tracking-wider bg-gradient-to-r from-primary to-orange-400 bg-clip-text text-transparent drop-shadow-lg mb-4">
                    NOTICIAS
                </h1>
                <p class="text-lg md:text-xl text-light/80 max-w-3xl mx-auto">
                    Mantenete al d칤a con todas las novedades, torneos y logros de Pucar치 Gaming
                </p>
            </header>

            <!-- Carrusel de publicaciones de Instagram/Facebook -->
            <section role="region" aria-labelledby="social-feed" class="mb-12">
                <h2 id="social-feed" class="text-2xl font-bold text-primary mb-6 text-center">
                    칔LTIMAS PUBLICACIONES
                </h2>
                
                <div id="posts-carousel" class="relative">
                    <!-- Loading state -->
                    <div id="loading-posts" class="text-center py-12">
                        <div class="animate-spin rounded-full h-12 w-12 border-t-4 border-b-4 border-primary mx-auto mb-4"></div>
                        <p class="text-light/70">Cargando publicaciones...</p>
                    </div>

                    <!-- Error state -->
                    <div id="error-posts" class="hidden text-center py-12 bg-gray-800/50 rounded-xl p-8 border border-red-500/20">
                        <div class="text-4xl mb-4">丘멆잺</div>
                        <p class="text-red-400">No se pudieron cargar las publicaciones</p>
                    </div>

                    <!-- Posts container -->
                    <div id="posts-container" class="hidden">
                        <div class="relative overflow-hidden">
                            <!-- Carousel wrapper -->
                            <div id="carousel-track" class="flex transition-transform duration-500 ease-in-out gap-6">
                                <!-- Los posts se cargar치n aqu칤 din치micamente -->
                            </div>
                        </div>

                        <!-- Navigation buttons -->
                        <div class="flex justify-center gap-4 mt-8">
                            <button id="prev-btn" class="bg-primary/20 hover:bg-primary text-white p-3 rounded-full transition-all disabled:opacity-30 disabled:cursor-not-allowed" aria-label="Anterior">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/>
                                </svg>
                            </button>
                            <button id="next-btn" class="bg-primary/20 hover:bg-primary text-white p-3 rounded-full transition-all disabled:opacity-30 disabled:cursor-not-allowed" aria-label="Siguiente">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/>
                                </svg>
                            </button>
                        </div>

                        <!-- Dots indicator -->
                        <div id="dots-container" class="flex justify-center gap-2 mt-4">
                            <!-- Los dots se generar치n din치micamente -->
                        </div>
                    </div>
                </div>
            </section>

            <!-- Pr칩ximamente (mantener como backup) -->
            <section role="region" aria-labelledby="development-section" class="text-center py-16">
                <div class="bg-gray-800/50 rounded-xl p-8 border border-primary/20 max-w-2xl mx-auto">
                    <div class="text-6xl mb-6" role="img" aria-label="Peri칩dico">游닗</div>
                    <h2 id="development-section" class="text-2xl md:text-3xl font-bold text-primary mb-4">
                        SECCI칍N EN DESARROLLO
                    </h2>
                    <p class="text-lg text-light/80 mb-6">
                        Estamos trabajando para traerte las 칰ltimas noticias del mundo esports y todas las novedades de nuestros equipos.
                    </p>
                    <nav role="navigation" aria-label="Enlaces relacionados" class="flex flex-col sm:flex-row gap-4 justify-center">
                        <a href="/teams" 
                           class="inline-flex items-center gap-2 bg-primary hover:bg-primary/80 text-white font-semibold px-6 py-3 rounded-lg transition-all duration-300 hover:scale-105 focus-visible"
                           aria-label="Ver p치gina de equipos de Pucar치 Gaming">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" role="img" aria-labelledby="users-title">
                                <title id="users-title">Icono de usuarios</title>
                                <path d="M16 7c0-2.21-1.79-4-4-4S8 4.79 8 7s1.79 4 4 4 4-1.79 4-4zm4 6v3h-3v-3h3zM12 19c-2.67 0-8 1.34-8 4v1h16v-1c0-2.66-5.33-4-8-4z"/>
                            </svg>
                            VER EQUIPOS
                        </a>
                        <a href="/contact" 
                           class="inline-flex items-center gap-2 bg-gray-700 hover:bg-gray-600 text-white font-semibold px-6 py-3 rounded-lg transition-all duration-300 focus-visible"
                           aria-label="Ir a la p치gina de contacto">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" role="img" aria-labelledby="contact-envelope-title">
                                <title id="contact-envelope-title">Icono de sobre de correo</title>
                                <path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z"/>
                            </svg>
                            CONTACTO
                        </a>
                    </nav>
                </div>
            </section>

            <!-- Secciones futuras -->
            <section role="region" aria-labelledby="future-sections">
                <h2 id="future-sections" class="sr-only">Secciones futuras disponibles</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mt-12">
                    <article class="bg-gray-800/30 p-6 rounded-lg border border-primary/10" role="article">
                        <div class="text-3xl mb-4" role="img" aria-label="Trofeo">游끥</div>
                        <h3 class="text-xl font-bold text-primary mb-2">TORNEOS</h3>
                        <p class="text-light/70">Resultados y calendario de competencias</p>
                    </article>
                    
                    <article class="bg-gray-800/30 p-6 rounded-lg border border-primary/10" role="article">
                        <div class="text-3xl mb-4" role="img" aria-label="Control de videojuego">游꿡</div>
                        <h3 class="text-xl font-bold text-primary mb-2">EQUIPOS</h3>
                        <p class="text-light/70">Novedades y actualizaciones de nuestros jugadores</p>
                    </article>
                    
                    <article class="bg-gray-800/30 p-6 rounded-lg border border-primary/10" role="article">
                        <div class="text-3xl mb-4" role="img" aria-label="Meg치fono">游닉</div>
                        <h3 class="text-xl font-bold text-primary mb-2">ANUNCIOS</h3>
                        <p class="text-light/70">Comunicados oficiales y nuevos proyectos</p>
                    </article>
                </div>
            </section>
        </div>
    </main>

    <script>
        let currentIndex = 0;
        let posts = [];
        const postsPerPage = window.innerWidth >= 1024 ? 3 : (window.innerWidth >= 768 ? 2 : 1);

        async function loadPosts() {
            try {
                const response = await fetch('/api/instagram-posts');
                const data = await response.json();

                if (data.error) {
                    showError();
                    return;
                }

                posts = data.posts;
                if (posts.length === 0) {
                    showError();
                    return;
                }

                renderPosts();
                document.getElementById('loading-posts').classList.add('hidden');
                document.getElementById('posts-container').classList.remove('hidden');
            } catch (error) {
                console.error('Error loading posts:', error);
                showError();
            }
        }

        function renderPosts() {
            const track = document.getElementById('carousel-track');
            const dotsContainer = document.getElementById('dots-container');
            
            if (!track || !dotsContainer) return;

            // Limpiar contenido anterior
            track.innerHTML = '';
            dotsContainer.innerHTML = '';

            // Renderizar posts
            posts.forEach((post, index) => {
                const postElement = document.createElement('div');
                postElement.className = 'min-w-full md:min-w-[calc(50%-12px)] lg:min-w-[calc(33.333%-16px)] bg-gray-800/50 rounded-lg overflow-hidden border border-primary/20 hover:border-primary/50 transition-all';
                
                const isVideo = post.media_type === 'VIDEO';
                const imageUrl = isVideo ? (post.thumbnail_url || post.media_url) : post.media_url;
                const caption = post.caption || post.message || 'Sin descripci칩n';
                const link = post.permalink || post.permalink_url || '#';
                
                postElement.innerHTML = `
                    <a href="${link}" target="_blank" rel="noopener noreferrer" class="block group">
                        <div class="relative aspect-square overflow-hidden bg-gray-900">
                            ${imageUrl ? `
                                <img 
                                    src="${imageUrl}" 
                                    alt="${caption.substring(0, 100)}"
                                    class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-300"
                                    loading="lazy"
                                />
                            ` : `
                                <div class="w-full h-full flex items-center justify-center text-6xl">
                                    游닝
                                </div>
                            `}
                            ${isVideo ? `
                                <div class="absolute inset-0 flex items-center justify-center bg-black/30">
                                    <svg width="64" height="64" viewBox="0 0 24 24" fill="white" class="drop-shadow-lg">
                                        <path d="M8 5v14l11-7z"/>
                                    </svg>
                                </div>
                            ` : ''}
                        </div>
                        <div class="p-4">
                            <p class="text-light/80 text-sm line-clamp-3">
                                ${caption}
                            </p>
                            <div class="mt-3 flex items-center justify-between text-xs text-primary">
                                <span>Ver en ${data.source === 'instagram' ? 'Instagram' : 'Facebook'}</span>
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/>
                                </svg>
                            </div>
                        </div>
                    </a>
                `;
                
                track.appendChild(postElement);
            });

            // Crear dots
            const totalPages = Math.ceil(posts.length / postsPerPage);
            for (let i = 0; i < totalPages; i++) {
                const dot = document.createElement('button');
                dot.className = `w-3 h-3 rounded-full transition-all ${i === 0 ? 'bg-primary w-8' : 'bg-gray-600'}`;
                dot.setAttribute('aria-label', `Ir a p치gina ${i + 1}`);
                dot.addEventListener('click', () => goToPage(i));
                dotsContainer.appendChild(dot);
            }

            updateCarousel();
        }

        function updateCarousel() {
            const track = document.getElementById('carousel-track');
            const dots = document.querySelectorAll('#dots-container button');
            const prevBtn = document.getElementById('prev-btn');
            const nextBtn = document.getElementById('next-btn');
            
            if (!track) return;

            const totalPages = Math.ceil(posts.length / postsPerPage);
            const offset = -(currentIndex * (100 / postsPerPage));
            track.style.transform = `translateX(${offset}%)`;

            // Actualizar dots
            dots.forEach((dot, index) => {
                if (index === currentIndex) {
                    dot.classList.add('bg-primary', 'w-8');
                    dot.classList.remove('bg-gray-600');
                } else {
                    dot.classList.remove('bg-primary', 'w-8');
                    dot.classList.add('bg-gray-600');
                }
            });

            // Actualizar botones
            if (prevBtn && nextBtn) {
                prevBtn.disabled = currentIndex === 0;
                nextBtn.disabled = currentIndex >= totalPages - 1;
            }
        }

        function goToPage(index) {
            currentIndex = index;
            updateCarousel();
        }

        function showError() {
            document.getElementById('loading-posts').classList.add('hidden');
            document.getElementById('error-posts').classList.remove('hidden');
        }

        // Event listeners
        document.getElementById('prev-btn')?.addEventListener('click', () => {
            if (currentIndex > 0) {
                currentIndex--;
                updateCarousel();
            }
        });

        document.getElementById('next-btn')?.addEventListener('click', () => {
            const totalPages = Math.ceil(posts.length / postsPerPage);
            if (currentIndex < totalPages - 1) {
                currentIndex++;
                updateCarousel();
            }
        });

        // Cargar posts al iniciar
        loadPosts();

        // Responsive: recalcular al cambiar tama침o de ventana
        let resizeTimeout;
        window.addEventListener('resize', () => {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(() => {
                location.reload(); // Recargar para ajustar postsPerPage
            }, 500);
        });
    </script>

    <style>
        .line-clamp-3 {
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
    </style>
</Layout>
